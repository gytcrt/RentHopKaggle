---
title: "Kaggle-Renthop: Let's do some Visualization to help variable selection"
author: "Yuan(Andrea) Gao"
date: "February 17, 2017"
output: html_document
---

Renthop is a New York apartment search engine. They launched a competition and post a dataset of their listings on Kaggle. Their primary goal is to handle fraud control, identify potential list quality issues, and allow owners and agents to better understand rentersâ€™ needs and preferences. I found this project extremely interesting because I want to be familiar apartment in New York and I want to know where is a good location to move in New York.

```{r load data, include=FALSE, echo=FALSE, eval=FALSE}
require(tidyr)
require(rjson)
require(dplyr)
require(purrr)
require(knitr)
require(stringr)
require(h2o)
require(lubridate)
require(data.table)
train = fromJSON(file = "train.json")
test = fromJSON(file = "test.json")

column <- setdiff(names(train), c("photos", "features"))
train <- map_at(train, column, unlist) %>% tibble::as_tibble(.)
# Number of listing in train set
#nrow(train)
test <- map_at(test, column, unlist) %>% tibble::as_tibble(.)
# Number of listing in test set
#nrow(test)

```


```{r, warning=FALSE, error=FALSE}
require(tidyr)
require(rjson)
require(dplyr)
require(purrr)
require(knitr)
require(stringr)
require(h2o)
require(lubridate)
require(data.table)
load("renthop.RData")
```

### Target Variable

Looking at the bar graph of `interest level` below, most of listings belong to low interst group. It means most listings were not  inquired by customers. Accurately, near 70% of the listings are in `low interest` group and only 7% of the listings are actively inquired. 

```{r, message=FALSE}
require(ggplot2)
# Factorize interest_level
train$interest_level = as.factor(train$interest_level)

#reorder position
position = c("low", "medium", "high")

interest_color = c("#ccebc5", "#b3cde3", "#fbb4ae")

ggplot(train, aes(interest_level, fill = interest_level)) + 
  geom_bar(width = 0.4) +
  scale_x_discrete(limits = position) +
  scale_fill_brewer(palette = "Set1") +
  labs(title = "Bar graph of interest_levet")

train %>% group_by(interest_level) %>%
  summarise(count = n()/nrow(train)) %>%
  kable()

```

### Number of rooms and price of lists

Obviously, listings on RentHop with lower price attract more interst than than more expensive listings.

```{r room, message=FALSE}
require(GGally)

# density of price by interest levels 
ggplot(train, aes(price, colour = interest_level)) +
  geom_density(size = 2) +
  xlim(0, 10000) +
  scale_colour_brewer(palette = "Set1") +
  labs(title = "Price density of different interest_level")

```


Since around 80% of the listings have exactly 1 bathroom, I didn't include bathroom into paried graph.

By observing the paired graphs, we can easily find some trends:

* Again, listings with high interest leavel tend to have lower price.
* Listings with 2 or 3 bedrooms seem to be more popular (with high interest level) because renting a bedroom and sharing living room with some roommate can considerably lower rental cost for most tenants. 


```{r, message=FALSE}
# Percentage of listings higher than 10000 dollor
sum(train$price > 10000)/nrow(train)

# Percentage of listings have 1 bathroom
sum(train$bathrooms == 1)/nrow(train)

# GGally
var = train %>%
  select(bedrooms, price, interest_level) %>%
  filter(price < 10000, bedrooms <5) %>%
  mutate(
    bedrooms = factor(bedrooms),
    interest_level = factor(interest_level)
  ) 

pair_graph = ggpairs(var, mapping = aes(color = interest_level)) +
  labs(title = "Paired graphs of bedroom, price and interst_level ")

for (row in seq_len(pair_graph$nrow))
  for (col in seq_len(pair_graph$ncol)){
    pair_graph[row, col] = pair_graph[row, col] + 
      scale_colour_brewer(palette = "Set1") +
      scale_fill_brewer(palette = "Set1")
  }

pair_graph
```


### Visualize interest level on map

To find how location of a listing influences its interest level, I point every list on New York map based on their interest level. Surpurisingly, the three maps are actually very similar. I have to say I cannot easily find which part of the city is more popular than the others. 

From my common sense, the location of an apartment is definitely important for tenant, since the location largely impacts safty, public transportation and education. Therefore, I think the street or community of an apartment might be more important for tenant than pure geological location when they browse on Renthop. 

```{r high interest level, message=FALSE, warning=FALSE, error=FALSE}
require(ggmap)
require(ggplot2)

# High interest level listings on map
nymap = get_map("Manhattan Bridges", zoom=11, maptype="toner", source="stamen")
ggmap(nymap, extent = "device") +
  geom_point(data = train %>%
               filter(interest_level == "high"), 
             aes(x=longitude, y=latitude), 
             color= "#e41a1c",
             size = 1,
             alpha=0.5) +
  labs(title = "Map of listings with high interest level")

```


```{r medium interest level, message=FALSE}
# Midium interest level listings on map
ggmap(nymap, extent = "device") +
  geom_point(data = train %>%
               filter(interest_level == "medium"), 
             aes(x=longitude, y=latitude), 
             color="#377eb8",
             size = 0.7,
             alpha=0.5) +
  labs(title = "Map of listings with medium interest level")
```
```{r low interest level, message=FALSE}

# low interest level listings on map
ggmap(nymap, extent = "device") +
  geom_point(data = train %>%
               filter(interest_level == "low"), 
             aes(x=longitude, y=latitude), 
             color="#4daf4a",
             size = 0.3,
             alpha=0.5) +
  labs(title = "Map of listings with low interest level")
```

### How does photo influence interest_levet?

Note I've found 70% of the listings are in low interest level group and only 7% of the listings are in high interest level group. 

```{r photo, message=FALSE, warning=FALSE}
# count number of photo
train$photo_count = train$photos %>% 
#  select(photos) %>%
  map_int(length)

table(train$photo_count)



# summarize photo info
train$photo_count = as.character(train$photo_count)
train$photo_n = as.numeric(ave(train$photo_count, train$photo_count, FUN = length))
  
train$photo_count = as.integer(train$photo_count)

train_photo = train %>% 
  filter(photo_count<20) %>%
  group_by(photo_count, interest_level, photo_n) %>%
  summarise(count_byphoto = n(),
            mean_price = mean(price)) %>%
  mutate(count_pct = count_byphoto/photo_n)

kable(train_photo, digits = 2, caption = " Photo and interest_level")

ggplot(data = train %>% filter(photo_count<20, interest_level == "low"), aes(photo_count)) +
  geom_bar(fill = interest_color[1], alpha=1) #+
#  facet_grid(~ interest_level)

ggplot(data = train %>% filter(photo_count<20, interest_level == "medium"), aes(photo_count)) +
  geom_bar(fill = interest_color[2], alpha=1)

ggplot(data = train %>% filter(photo_count<20, interest_level == "high"), aes(photo_count)) +
  geom_bar(fill = interest_color[3])


# bar chart 
ggplot(data = train_photo %>% filter(interest_level == "low")) +
  geom_bar(aes(x = photo_count, y = count_pct), 
           stat = "identity",
           fill = interest_color[1]) +
  geom_hline(yintercept = 0.69)

ggplot(data = train_photo %>% filter(interest_level == "medium")) +
  geom_bar(aes(x = photo_count, y = count_pct), 
           stat = "identity",
           fill = interest_color[2]) +
  geom_hline(yintercept = 0.227)

ggplot(data = train_photo %>% filter(interest_level == "high")) +
  geom_bar(aes(x = photo_count, y = count_pct), 
           stat = "identity",
           fill = interest_color[3]) +
  geom_hline(yintercept = 0.0777)
```

### How about different managers?

```{r manager, message=FALSE, error=FALSE, warning=FALSE}
require(reshape2)

train_manager = dcast(train, manager_id ~ interest_level) %>% 
  group_by(manager_id) %>%
  mutate(manager_count = low+medium+high) %>%
  mutate(low_prob = round(low/manager_count, 2),
         medium_prob = round(medium/manager_count, 2),
         high_prob = round(high/manager_count, 2)) %>%
  arrange(desc(high), desc(high_prob))

train_manager %>% 
  head(50) %>%
  kable(format = "html", caption = "interest_level by manager")

```

### How about features?

Browsing the data, I think the 'decrption', 'feature' and 'photo' columns should contain pretty valuable information, but they are a little bit hard to cope with. Here I tried to deal with 'feature'

Let's play with the feature column.

## Count feature 

```{r feature, message=FALSE}
# Total number of feature in train set
length(unique(train$features))

# Summarize count of features
feature = data.frame(feature = tolower(unlist(train$features))) %>% # convert all features to lower case
  group_by(feature) %>%
  summarise(feature_count = n()) %>%
  arrange(desc(feature_count)) %>%
  filter(feature_count >= 50) %>%
  mutate(feature_percent = feature_count/nrow(train))

kable(feature, caption = "Feature Count")

```

## Synonymic features
```{r synonym}
# Hardwood
feature %>%
  filter(str_detect(feature, 'wood')) %>%
  kable(caption = "hardwood") 

# Laundry in unit
feature %>%
  filter(str_detect(feature, paste(c('laundry', 'dryer', 'washer'), collapse="|"))) %>%
  filter(!str_detect(feature, "dishwasher")) %>%
  kable(caption = "Laundry in unit")

# Roof deck
feature %>%
  filter(str_detect(feature, 'roof')) %>%
  kable(caption = "Roof Deck")

# Outdoor space
feature %>%
  filter(str_detect(feature, 'outdoor')) %>%
  kable(caption = "Outdoor Space")

# Garden
feature %>%
  filter(str_detect(feature, 'garden')) %>%
  kable(caption = "Garden")

# Park
feature %>%
  filter(str_detect(feature, 'park')) %>%
  kable(caption = "Parking")
```

We can easily observe from the table:

* Among 10254 unique feature tags, most features are from the top 10 features
* Only 89 features show more than 50 times in the train set. 
* Among the list of top 89 features, many of them overlap with each other.

Therefore, we can transform features into categorical data, and reduce the number of categories by setting a cutoff count and combining similar features. 

```{r feature engineering, message=FALSE}

lanudry = c("laundry in building", "laundry room", "on-site laundry", "laundry in unit", "dryer in unit", "washer in unit", "washer/dryer", "laundry")
roofdeck = c("roof-deck", "roofdeck", "common roof deck", "roof deck")
outdoorspace = c("common outdoor space", "private outdoor space", "publicoutdoor", "outdoor areas", "outdoor space")

# Combine similar features
feature = data.frame(feature = tolower(unlist(train$features))) %>% # Hardwood
  map_df(~ gsub("hardwood floor", "hardwood", .x)) %>%
  map_df(~ gsub("hardwoods", "hardwood", .x)) %>%
  map_df(~ gsub(paste0(lanudry, collapse="|"), "laundry", .x)) %>%
  map_df(~ gsub(paste0(roofdeck, collapse="|"), "roof deck", .x)) %>%
  map_df(~ gsub(paste0(outdoorspace, collapse="|"), "outdoor space", .x)) %>%
  group_by(feature) %>%
  summarise(feature_count = n()) %>%
  arrange(desc(feature_count)) %>%
  filter(feature_count >= 50) %>%
  mutate(feature_percent = feature_count/nrow(train)) %>% 
  filter(feature_percent>0.1)

kable(feature, caption = "top 10 features")

```

Okay, after I merged similar synonymic features. To avoid including too many featues, I sort features by their frequencies, and I pick features listed in more than 10% of appartments. As the table shown above, I only need to add 13 features to the original dataset.



```{r feature matrix, message=FALSE, echo=FALSE}

# train set
feature_matrix = data.frame(matrix(0, ncol = nrow(feature), nrow = nrow(train))) %>%
  setNames(feature$feature)

# clean feature cloumn 
feature_matrix$feature = train$features %>%
  map(paste, collapse=" ") %>%
  map(tolower)%>% # Hardwood
  map_chr(~ gsub("hardwood floor", "hardwood", .x)) %>%
  map_chr(~ gsub("hardwoods", "hardwood", .x)) %>%
  map_chr(~ gsub(paste0(lanudry, collapse="|"), "laundry", .x)) %>%
  map_chr(~ gsub(paste0(roofdeck, collapse="|"), "roof deck", .x)) %>%
  map_chr(~ gsub(paste0(outdoorspace, collapse="|"), "outdoor space", .x))


#feature_matrix$laundry = feature_matrix$feature %>%
#  map_chr(~str_detect(.x, "laundry") %>% as.integer)


#feature_matrix[, colnames(feature_matrix)[1]] = feature_matrix$feature %>%
#  map_chr(~str_detect(.x, "laundry") %>% as.integer)

for(col in colnames(feature_matrix)[-ncol(feature_matrix)]) {
  feature_matrix[, col] = feature_matrix$feature %>%
    map_chr(~str_detect(.x, col) %>% as.integer)
  print(col)
}

train_feature = cbind(train, feature_matrix)


# test set
feature_matrix = data.frame(matrix(0, ncol = nrow(feature), nrow = nrow(test))) %>%
  setNames(feature$feature)

# clean feature cloumn 
feature_matrix$feature = test$features %>%
  map(paste, collapse=" ") %>%
  map(tolower)%>% # Hardwood
  map_chr(~ gsub("hardwood floor", "hardwood", .x)) %>%
  map_chr(~ gsub("hardwoods", "hardwood", .x)) %>%
  map_chr(~ gsub(paste0(lanudry, collapse="|"), "laundry", .x)) %>%
  map_chr(~ gsub(paste0(roofdeck, collapse="|"), "roof deck", .x)) %>%
  map_chr(~ gsub(paste0(outdoorspace, collapse="|"), "outdoor space", .x))


for(col in colnames(feature_matrix)[-ncol(feature_matrix)]) {
  feature_matrix[, col] = feature_matrix$feature %>%
    map_chr(~str_detect(.x, col) %>% as.integer)
  print(col)
}

test_feature = cbind(test, feature_matrix)

# Select predictors
feature_factor = c("bathrooms", "bedrooms", "manager_id", "laundry", "elevator", "hardwood", "cats allowed", "dogs allowed", "doorman", "dishwasher", "no fee", "fitness center", "pre-war", "outdoor space", "roof deck", "dining room")

test_feature$month = month(test_feature$created)
test_feature$day = day(test_feature$created)

# Factorize variables
for(fea in feature_factor){
test_feature[, fea] = as.factor(test_feature[, fea])
}


train_feature$month = month(train_feature$created)
train_feature$day = day(train_feature$created)
# Factorize variables
for(fea in feature_factor){
train_feature[, fea] = as.factor(train_feature[, fea])
}
train_feature$interest_level = as.factor(train_feature$interest_level)

trainset = train_feature %>% select(bathrooms, bedrooms, month, day, latitude, longitude, manager_id, price, elevator, hardwood, laundry, `cats allowed`, `dogs allowed`, doorman, dishwasher, `fitness center`, `pre-war`, `no fee`, interest_level)

testset = test_feature %>% select(bathrooms, bedrooms, month, day, latitude, longitude, manager_id, price, elevator, hardwood, laundry, `cats allowed`, `dogs allowed`, doorman, dishwasher, `fitness center`, `pre-war`, `no fee`)

save(trainset, file = "TrainFeature.Rdata")

```


```{r feature and interest level, message=FALSE, warning=FALSE}
require(scales)
load("TrainFeature.Rdata")
# Elevator
ggplot(trainset %>% dcast(interest_level ~ elevator) %>% melt, aes(x = variable, y = value, fill = interest_level)) +
  geom_bar(position = "fill",stat = "identity") +
  scale_y_continuous(labels = percent_format()) +
  scale_fill_brewer(palette = "Set1") +
  labs(title = "Elevator")

# Hardwood
ggplot(trainset %>% dcast(interest_level ~ hardwood) %>% melt, aes(x = variable, y = value, fill = interest_level)) +
  geom_bar(position = "fill",stat = "identity") +
  scale_y_continuous(labels = percent_format()) +
  scale_fill_brewer(palette = "Set1") +
  labs(title = "Hardwood")

# Laundry
ggplot(trainset %>% dcast(interest_level ~ laundry) %>% melt, aes(x = variable, y = value, fill = interest_level)) +
  geom_bar(position = "fill",stat = "identity") +
  scale_y_continuous(labels = percent_format()) +
  scale_fill_brewer(palette = "Set1") +
  labs(title = "Laundry")
 
# cats allowed
ggplot(trainset %>% dcast(interest_level ~ `cats allowed`) %>% melt, aes(x = variable, y = value, fill = interest_level)) +
  geom_bar(position = "fill",stat = "identity") +
  scale_y_continuous(labels = percent_format()) +
  scale_fill_brewer(palette = "Set1") +
  labs(title = "Cats allowed")

# dogs allowed
ggplot(trainset %>% dcast(interest_level ~ `dogs allowed`) %>% melt, aes(x = variable, y = value, fill = interest_level)) +
  geom_bar(position = "fill",stat = "identity") +
  scale_y_continuous(labels = percent_format()) +
  scale_fill_brewer(palette = "Set1") +
  labs(title = "Dogs allowed")

# doorman
ggplot(trainset %>% dcast(interest_level ~ doorman) %>% melt, aes(x = variable, y = value, fill = interest_level)) +
  geom_bar(position = "fill",stat = "identity") +
  scale_y_continuous(labels = percent_format()) +
  scale_fill_brewer(palette = "Set1") +
  labs(title = "Doorman")

#dishwasher
ggplot(trainset %>% dcast(interest_level ~ dishwasher) %>% melt, aes(x = variable, y = value, fill = interest_level)) +
  geom_bar(position = "fill",stat = "identity") +
  scale_y_continuous(labels = percent_format()) +
  scale_fill_brewer(palette = "Set1") +
  labs(title = "Dishwasher")

# fitness room => reduce high interest level
ggplot(trainset %>% dcast(interest_level ~ `fitness center`) %>% melt, aes(x = variable, y = value, fill = interest_level)) +
  geom_bar(position = "fill",stat = "identity") +
  scale_y_continuous(labels = percent_format()) +
  scale_fill_brewer(palette = "Set1") +
  labs(title = "Fitness room")

# pre-war => reduce high interest level
ggplot(trainset %>% dcast(interest_level ~ `pre-war`) %>% melt, aes(x = variable, y = value, fill = interest_level)) +
  geom_bar(position = "fill",stat = "identity") +
  scale_y_continuous(labels = percent_format()) +
  scale_fill_brewer(palette = "Set1") +
  labs(title = "Pre-war")

# no fee
ggplot(trainset %>% dcast(interest_level ~ `no fee`) %>% melt, aes(x = variable, y = value, fill = interest_level)) +
  geom_bar(position = "fill",stat = "identity") +
  scale_y_continuous(labels = percent_format()) +
  scale_fill_brewer(palette = "Set1") +
  labs(title = "No fee")
```


